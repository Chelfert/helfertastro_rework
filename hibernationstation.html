<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Hibernate Skipper</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #121212;
            color: #ffffff;
        }
        
        .container {
            background: #282828;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        button {
            background: #1DB954;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        
        button:hover {
            background: #1ed760;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
            background: #333;
        }
        
        .log {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 4px;
            word-break: break-all;
        }

        #debug {
            margin-top: 20px;
            padding: 15px;
            background: #333;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spotify Hibernate Skipper</h1>
        <button id="authorize">Connect to Spotify</button>
        <button id="start" disabled>Start Monitoring</button>
        <button id="stop" disabled>Stop Monitoring</button>
        <div id="status">Status: Not connected</div>
        <div id="debug">
            Redirect URI: <span id="redirectUri"></span>
        </div>
        <div id="log"></div>
    </div>

    <script>
        const clientId = '3d1da1b5cb8f44c283ef5986caa20464'; // Replace with your client ID
        const redirectUri = window.location.href.split('#')[0];  // Get current URL without hash
        let accessToken = null;
        let hibernatePlaylistId = null;
        let hibernateTracks = new Set();
        let monitoringInterval = null;

        // Show the redirect URI being used
        document.getElementById('redirectUri').textContent = redirectUri;
        log('Using redirect URI: ' + redirectUri);

        // Initialize the application
        window.onload = () => {
            const hash = window.location.hash;
            if (hash) {
                const params = new URLSearchParams(hash.substring(1));
                accessToken = params.get('access_token');
                if (accessToken) {
                    document.getElementById('authorize').disabled = true;
                    document.getElementById('start').disabled = false;
                    updateStatus('Connected to Spotify');
                    findHibernatePlaylist();
                }
            }
        };

        // Event Listeners
        document.getElementById('authorize').addEventListener('click', authorize);
        document.getElementById('start').addEventListener('click', startMonitoring);
        document.getElementById('stop').addEventListener('click', stopMonitoring);

        // Authorization function
        function authorize() {
            const scopes = [
                'user-read-playback-state',
                'user-modify-playback-state',
                'playlist-read-private'
            ];

            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}` +
                `&response_type=token` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&scope=${encodeURIComponent(scopes.join(' '))}`;

            log('Attempting authorization with URL: ' + authUrl);
            window.location.href = authUrl;
        }

        // Find the Hibernate playlist
        async function findHibernatePlaylist() {
            try {
                let offset = 0;
                let found = false;

                while (!found) {
                    const response = await fetch(`https://api.spotify.com/v1/me/playlists?limit=50&offset=${offset}`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    const data = await response.json();
                    
                    if (!data.items.length) break;

                    const hibernatePlaylist = data.items.find(playlist => 
                        playlist.name.toLowerCase() === 'hibernate'
                    );

                    if (hibernatePlaylist) {
                        hibernatePlaylistId = hibernatePlaylist.id;
                        found = true;
                        log(`Found Hibernate playlist: ${hibernatePlaylist.name}`);
                        await cacheHibernateTracks();
                    }

                    offset += data.items.length;
                }

                if (!found) {
                    log('Could not find Hibernate playlist');
                }
            } catch (error) {
                log('Error finding Hibernate playlist: ' + error.message);
            }
        }

        // Cache all tracks from the Hibernate playlist
        async function cacheHibernateTracks() {
            try {
                let offset = 0;
                hibernateTracks.clear();

                while (true) {
                    const response = await fetch(
                        `https://api.spotify.com/v1/playlists/${hibernatePlaylistId}/tracks?fields=items(track(id)),total&offset=${offset}`,
                        {
                            headers: { 'Authorization': `Bearer ${accessToken}` }
                        }
                    );
                    
                    const data = await response.json();
                    
                    if (!data.items.length) break;

                    data.items.forEach(item => {
                        if (item.track && item.track.id) {
                            hibernateTracks.add(item.track.id);
                        }
                    });

                    offset += data.items.length;
                }

                log(`Cached ${hibernateTracks.size} tracks from Hibernate playlist`);
            } catch (error) {
                log('Error caching tracks: ' + error.message);
            }
        }

        // Check current playing track and skip if in Hibernate playlist
        async function checkAndSkipCurrent() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.status === 204) {
                    return; // Nothing playing
                }

                const data = await response.json();
                
                if (!data || !data.item) return;

                if (hibernateTracks.has(data.item.id)) {
                    await fetch('https://api.spotify.com/v1/me/player/next', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    log(`Skipped track: ${data.item.name}`);
                }
            } catch (error) {
                log('Error checking current track: ' + error.message);
            }
        }

        // Start monitoring
        function startMonitoring() {
            if (!monitoringInterval) {
                document.getElementById('start').disabled = true;
                document.getElementById('stop').disabled = false;
                monitoringInterval = setInterval(checkAndSkipCurrent, 1000);
                updateStatus('Monitoring active');
                log('Started monitoring');
            }
        }

        // Stop monitoring
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                document.getElementById('start').disabled = false;
                document.getElementById('stop').disabled = true;
                updateStatus('Monitoring stopped');
                log('Stopped monitoring');
            }
        }

        // Utility functions
        function updateStatus(message) {
            document.getElementById('status').textContent = `Status: ${message}`;
        }

        function log(message) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }
    </script>
</body>
</html>